<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AI Chatt-widget</title>
  <style>
    .chat { max-width: 420px; margin: 2rem auto; border: 1px solid #ddd; border-radius: 12px; padding: 12px; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; }
    .msg { padding: 8px 10px; border-radius: 10px; margin: 6px 0; white-space: pre-wrap; }
    .ai { background: #f3f4f6; }
    .me { background: #e5f6ff; text-align: right; }
    .input { display: flex; gap: 8px; margin-top: 10px; }
    .input input { flex: 1; padding: 10px; border-radius: 10px; border: 1px solid #ddd; }
    .input button { padding: 10px 14px; border-radius: 10px; border: 1px solid #ddd; background: white; cursor: pointer; }
    .lead { display: none; border-top: 1px dashed #ddd; margin-top: 10px; padding-top: 10px; }
    .lead input { width: 100%; padding: 8px; margin: 6px 0; border: 1px solid #ddd; border-radius: 8px; }
    .small { color: #666; font-size: 12px; }
  </style>
</head>
<body>
  <div class="chat">
    <div id="messages"></div>
    <div class="input">
      <input id="prompt" placeholder="Skriv din fråga..." />
      <button id="send">Skicka</button>
    </div>

    <div class="lead" id="lead">
      <div class="small">Lämna dina uppgifter så återkommer vi.</div>
      <input id="name" placeholder="Namn (frivilligt)" />
      <input id="email" placeholder="E-post" />
      <input id="phone" placeholder="Telefon" />
      <input id="company" placeholder="Företag (frivilligt)" />
      <input id="need" placeholder="Vad behöver du hjälp med? (frivilligt)" />
      <button id="saveLead">Skicka</button>
      <div class="small">Genom att skicka godkänner du vår integritetspolicy.</div>
    </div>
  </div>

<script>
const API_BASE = 'http://localhost:3000';
const messagesEl = document.getElementById('messages');
const promptEl = document.getElementById('prompt');
const sendBtn = document.getElementById('send');
const leadEl = document.getElementById('lead');
const saveLeadBtn = document.getElementById('saveLead');

let history = [];
let sessionId = localStorage.getItem('chat_session_id') || (Math.random().toString(36).slice(2));
localStorage.setItem('chat_session_id', sessionId);

function addMessage(text, role) {
  const div = document.createElement('div');
  div.className = 'msg ' + (role === 'user' ? 'me' : 'ai');
  div.textContent = text;
  messagesEl.appendChild(div);
  messagesEl.scrollTop = messagesEl.scrollHeight;
}

function maybeShowLeadForm(text) {
  const trigger = /boka|offert|kontakt|ring|prata med en människa|demo/i;
  if (trigger.test(text)) {
    leadEl.style.display = 'block';
  }
}

async function sendMessage() {
  const text = promptEl.value.trim();
  if (!text) return;
  addMessage(text, 'user');
  promptEl.value = '';

  try {
    const res = await fetch(API_BASE + '/api/chat', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'X-Session': sessionId },
      body: JSON.stringify({ message: text, history })
    });
    if (!res.ok) throw new Error('Fel från servern');
    const data = await res.json();
    const reply = data.reply || '(Inget svar)';
    addMessage(reply, 'assistant');
    history.push({ role: 'user', content: text }, { role: 'assistant', content: reply });
    maybeShowLeadForm(text + ' ' + reply);
  } catch (e) {
    addMessage('Oj, något gick fel. Försök igen senare.', 'assistant');
    console.error(e);
  }
}

async function saveLead() {
  const payload = {
    name: document.getElementById('name').value.trim(),
    email: document.getElementById('email').value.trim(),
    phone: document.getElementById('phone').value.trim(),
    company: document.getElementById('company').value.trim(),
    need: document.getElementById('need').value.trim(),
  };
  if (!payload.email && !payload.phone) {
    alert('Ange minst e-post eller telefon.');
    return;
  }
  try {
    const res = await fetch(API_BASE + '/api/lead', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'X-Session': sessionId },
      body: JSON.stringify(payload)
    });
    const data = await res.json();
    if (data.ok) {
      addMessage('Tack! En kollega återkommer till dig inom 1 arbetsdag.', 'assistant');
      leadEl.style.display = 'none';
    } else {
      throw new Error('Lead ej sparad');
    }
  } catch (e) {
    alert('Kunde inte spara. Försök igen senare.');
  }
}

sendBtn.addEventListener('click', sendMessage);
promptEl.addEventListener('keydown', (e) => { if (e.key === 'Enter') sendMessage(); });
saveLeadBtn.addEventListener('click', saveLead);
</script>
</body>
</html>
